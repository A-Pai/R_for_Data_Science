# 数据规整 {#tidyr}



```{r message = FALSE, warning = FALSE}
library(tidyverse)
```

这里我们有一个植物生成的数据，有三列

```{r}
plant_heigt <- data.frame(
  Day = 1:5,
  A = c(0.7, 1.0, 1.5, 1.8, 2.2),
  B = c(0.5, 0.7, 0.9, 1.3, 1.8)
)

plant_heigt
```



```{block, type="danger"}
大家想想，

- 把植物高度大于或等于0.8cm的**筛选**出来，怎么写语句?
- 用不同的颜色画出两种植物**生长曲线**，怎么写语句?
```


```{r, eval = FALSE}
plant_heigt %>% 
  filter( ___ >= 0.8)
```


```{r, eval = FALSE}
plant_heigt %>% 
  ggplot(aes(x = Day, y = ___, color = ___)) +
  geom_line()
```


想用上面的语句，数据就得变形。那么怎么变形呢？ 

```{r out.width = '100%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/make_data_tidy.png")
```


```{r eval=FALSE, include=FALSE}
melted <- gather(plant_heigt, variable, value, 2:3)

## Column names instead of indices
melted <- gather(plant_heigt, variable, value, variable1, variable2)

## Excluding instead of including
melted <- gather(plant_heigt, variable, value, -1)

## Excluding using column name
melted <- gather(plant_heigt, variable, value, -id)
```




从2019年9月份，[tidyr](<https://tidyr.tidyverse.org/>) 1.0.0新增了一组函数`pivot_longer()/pivot_wider()`，用来补充和完善原来的`gather()/spread()` 


* `gather()/pivot_longer `  it makes “wide” data longer.
* `spread()/pivot_wider`  it makes “long” data wider.


```{r out.width = '100%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/tidyr-fig.png")
```

所以现在使用`pivot_longer()`函数
```{r}
long <- pivot_longer(plant_heigt, 2:3,
  names_to = "plant",
  values_to = "height"
)
long
```



```{r}
plant_heigt %>% 
  pivot_longer(
  cols = -Day,                 # A:B 或者 c(A, B) 或者 c("A", "B")
  names_to = "plant",
  values_to = "height"
)

```



```{r}
long %>% 
  ggplot(aes(x = Day, y = height, color = plant)) +
  geom_line()
```

```{r}
wide <- long %>% 
  pivot_wider(
  names_from = "plant",
  values_from = "height"
)
wide
```



##  From `gather()` to `pivot()`

make data tidy

```{r out.width = '100%', fig.align='left', echo = FALSE}
knitr::include_graphics("images/import_datatype01.png")
```

VARIABLE, OBSERVATION, VALUE

- Each variable is a column
- Each observation is a row
- Each type of observational unit is a table



