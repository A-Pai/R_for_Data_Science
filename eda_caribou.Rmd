# 探索性数据分析6 {#eda06}

本章我们分析加拿大哥伦比亚林地**驯鹿追踪数据**，数据包含了从1988年到2016年期间260只驯鹿，近250000个位置标签。

## 驯鹿位置跟踪

```{r, out.width='85%', fig.align='left'}
knitr::include_graphics("images/caribou_location.png")
```


大家可以在[这里](https://github.com/tacookson/data/tree/master/caribou-location-tracking)了解数据集的信息，它包含了两个数据集


```{r, eval=FALSE}
# devtools::install_github("thebioengineer/tidytuesdayR")
library(tidytuesdayR)

tuesdata <- tidytuesdayR::tt_load('2020-06-23')
# or
# tuesdata <- tidytuesdayR::tt_load(2020, week = 26)
```



```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(gganimate)

individuals <- readr::read_csv('./demo_data/caribou/individuals.csv')
locations <- readr::read_csv('./demo_data/caribou/locations.csv')
```


## 驯鹿的身份信息

```{r}
individuals %>% glimpse()
```


```{r}
individuals %>% count(animal_id)
```


我们发现有重复id的，怎么办？
```{r}
individuals %>% janitor::get_dupes(animal_id)
```



```{r}
individuals %>% 
  filter(deploy_on_latitude >50) %>% 
  ggplot(aes(x = deploy_on_longitude, y = deploy_on_latitude)) +
  geom_point(aes(color = study_site)) #+
  #borders("world", regions = "china")
```


## 性别比例


## 每个站点运动最频繁的前10的驯鹿


## 驯鹿的活动信息

简单点说，就是哪个驯鹿在什么时间出现在什么地方

```{r}
locations
```

```{r}
locations %>% 
  ggplot(aes(x = longitude, y = latitude)) +
  geom_point(aes(color = study_site)) 
```


## 选择某个驯鹿，查看他的活动轨迹

```{r}
example_animal <- locations %>% 
  dplyr::filter(animal_id == sample(animal_id, 1)) %>% 
   dplyr::arrange(timestamp)
example_animal
```


```{r, eval=FALSE}
"2010-03-28 21:00:44" %>% lubridate::as_date()
"2010-03-28 21:00:44" %>% lubridate::as_datetime()
"2010-03-28 21:00:44" %>% lubridate::quarter()
```

```{r}
example_animal %>% 
   dplyr::mutate(date = lubridate::as_date(timestamp)) %>% 

  ggplot(aes(x = longitude, y = latitude, color = date)) +
  geom_path()
```

```{r}
example_animal %>% 
   dplyr::mutate(quarter = lubridate::quarter(timestamp) %>% as.factor()) %>% 
  
  ggplot(aes(x = longitude, y = latitude, color = quarter)) +
  geom_path() +
  facet_wrap(vars(quarter)) +
  labs(title = "一只小驯鹿到处啊跑")
```

## 季节模式
看看驯鹿夏季和冬季运动模式


## 迁移速度

```{r}
location_with_speed <- locations %>% 
   dplyr::group_by(animal_id) %>% 
   dplyr::mutate(
    last_longitude = lag(longitude),
    last_latitude = lag(latitude),
    hours = as.numeric(difftime(timestamp, lag(timestamp), units = "hours")), 
    km = geosphere::distHaversine(
      cbind(longitude, latitude), cbind(last_longitude, last_latitude)) /1000, 
    speed = km/hours
   ) %>% 
   dplyr::ungroup()

location_with_speed
```


```{r}
location_with_speed %>% 
  ggplot(aes(x = speed)) +
  geom_histogram() +
  scale_x_log10()
```


## 动态展示

```{r}
library(gganimate)

example_animal %>% 
  ggplot(aes(x = longitude, y = latitude)) +
  geom_point() +
  transition_time(time = timestamp) +
  shadow_mark(past = TRUE) +
  labs(title = "date is {frame_time}")
  
```

## 更多

```{r}
df <- locations %>%
  filter(study_site == "Graham",
         year(timestamp) == 2002) %>%
  group_by(animal_id) %>%
  filter(as_date(min(timestamp)) == "2002-01-01",
         as_date(max(timestamp)) == "2002-12-31") %>%
  ungroup() %>%
  mutate(date = as_date(timestamp)) %>%
  group_by(animal_id, date) %>%
  summarise(longitude_centroid = mean(longitude),
            latitude_centroid = mean(latitude)) %>%
  ungroup() %>%
  complete(animal_id, date) %>%
  arrange(animal_id, date) %>%
  fill(longitude_centroid, latitude_centroid, .direction = "down")
```


```{r}
p <- df %>%
  ggplot(aes(longitude_centroid, latitude_centroid, colour = animal_id)) +
  geom_point(size = 2) +
  coord_map() +
  theme_void() +
  theme(legend.position = "none") +
  transition_time(time = date) +
  shadow_mark(alpha = 0.2, size = 0.8) +
  ggtitle("Caribou location on {frame_time}")
p
```


```{r}
p
```

